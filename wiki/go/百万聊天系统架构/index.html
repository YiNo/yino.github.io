<!doctype html><html lang=en dir=ltr><head><meta name=generator content="Hugo 0.123.7"><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="聊天系统架构 百万级 B/S # 场景：100w人同时在线
技术选型 # B/S架构下 通常有两种方案： 1. 客户端主动向服务器拉取数据 2. 服务器主动向客户端发送数据 以上两种情况在B/S架构下通常对应着：http轮询 和 websocket 在线用户达到一定量级情况下，客户端主动拉取数据就会达到一定的瓶颈：对单表、api压力过大； 因此在用户量级略高的情况下建议采用 websocket websocket单机架构 # websocket 单机架构 代码案例地址: gitee github
技术难点 # 内核瓶颈 推送量大：100W*10条/秒=1000W条/秒 内核瓶颈：linux内核发送TCP极限包频≈100w 锁瓶颈 需要维护一个100w人的流量在线集合，通常是一个字典结构 推送消息即遍历整个集合，顺序发送消息，耗时极长 推送期间，客户端一直在进行上下线，所以需要对 map上锁 cpu瓶颈 浏览器与服务器之间通常采用json格式通讯 json编码非常消耗cpu 每秒100w次json encode 解决方案 # 内核瓶颈 减少网络小包的发送 将同一秒内推送的弹幕合并成一条，合并后每秒推送次数只等于在线连接数 锁瓶颈 大锁拆为多个小锁 创建原子变量，每个连接可以+1分配到一个唯一id，利用ID做hash取模到某个set中推送消息即遍历整个集合，顺序发送消息，耗时极长 连接打散到多个集合中，每个集合有自己的锁 多线程并发推送多个集合，避免锁的竞争 读写锁取代互斥锁，多个推送任务可以并发便利相同集合 cpu瓶颈 浏览器与服务器之间通常采用json格式通讯，json编码非常消耗cpu，每秒100w次json encode；因此减少计算次数 单机瓶颈 还有以下
维护海量长链接会花费不少内存 消息推送瞬时消耗大量CPU资源 消息推送瞬时带宽高达400～600M（4-6Gbits）,是主要瓶颈 websocket分布式架构 # 网关集群 # 通过负载均衡将连接打散在不同的网关服务器上，网关服务器可横向扩展；
但是会引出一个新的问题：当服务器推送消息时如何知道指定的用户在哪个服务器上： 最简单的解决方案是：将消息广播到所有的网关服务器上，网关服务器自主去决策是否在当前服务器，并进行发送；因此需要一个逻辑集群
逻辑集群 # 基于HTTP/2 协议向gateway 集群分发消息；HTTP/2 支持连接复用，用作RPC性能更佳；"><meta name=theme-color content="#FFFFFF"><meta property="og:title" content><meta property="og:description" content="聊天系统架构 百万级 B/S # 场景：100w人同时在线
技术选型 # B/S架构下 通常有两种方案： 1. 客户端主动向服务器拉取数据 2. 服务器主动向客户端发送数据 以上两种情况在B/S架构下通常对应着：http轮询 和 websocket 在线用户达到一定量级情况下，客户端主动拉取数据就会达到一定的瓶颈：对单表、api压力过大； 因此在用户量级略高的情况下建议采用 websocket websocket单机架构 # websocket 单机架构 代码案例地址: gitee github
技术难点 # 内核瓶颈 推送量大：100W*10条/秒=1000W条/秒 内核瓶颈：linux内核发送TCP极限包频≈100w 锁瓶颈 需要维护一个100w人的流量在线集合，通常是一个字典结构 推送消息即遍历整个集合，顺序发送消息，耗时极长 推送期间，客户端一直在进行上下线，所以需要对 map上锁 cpu瓶颈 浏览器与服务器之间通常采用json格式通讯 json编码非常消耗cpu 每秒100w次json encode 解决方案 # 内核瓶颈 减少网络小包的发送 将同一秒内推送的弹幕合并成一条，合并后每秒推送次数只等于在线连接数 锁瓶颈 大锁拆为多个小锁 创建原子变量，每个连接可以+1分配到一个唯一id，利用ID做hash取模到某个set中推送消息即遍历整个集合，顺序发送消息，耗时极长 连接打散到多个集合中，每个集合有自己的锁 多线程并发推送多个集合，避免锁的竞争 读写锁取代互斥锁，多个推送任务可以并发便利相同集合 cpu瓶颈 浏览器与服务器之间通常采用json格式通讯，json编码非常消耗cpu，每秒100w次json encode；因此减少计算次数 单机瓶颈 还有以下
维护海量长链接会花费不少内存 消息推送瞬时消耗大量CPU资源 消息推送瞬时带宽高达400～600M（4-6Gbits）,是主要瓶颈 websocket分布式架构 # 网关集群 # 通过负载均衡将连接打散在不同的网关服务器上，网关服务器可横向扩展；
但是会引出一个新的问题：当服务器推送消息时如何知道指定的用户在哪个服务器上： 最简单的解决方案是：将消息广播到所有的网关服务器上，网关服务器自主去决策是否在当前服务器，并进行发送；因此需要一个逻辑集群
逻辑集群 # 基于HTTP/2 协议向gateway 集群分发消息；HTTP/2 支持连接复用，用作RPC性能更佳；"><meta property="og:type" content="article"><meta property="og:url" content="https://yino.github.io/wiki/go/%E7%99%BE%E4%B8%87%E8%81%8A%E5%A4%A9%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/"><meta property="article:section" content="wiki"><title>百万聊天系统架构 | sun17 wiki</title>
<link rel=manifest href=/manifest.json><link rel=icon href=/favicon.png type=image/x-icon><link rel=stylesheet href=/book.min.1639cc58b39d753e5ce211e45ca1950799431f352ff7bd1baadfa7fcedfe8043.css integrity="sha256-FjnMWLOddT5c4hHkXKGVB5lDHzUv970bqt+n/O3+gEM="><script defer src=/en.search.min.d110d89863acc53ad886dfd56e0afb27ef9a468b15a4a1bf2e3862fad81416b6.js integrity="sha256-0RDYmGOsxTrYht/Vbgr7J++aRosVpKG/Ljhi+tgUFrY="></script><script defer src=/sw.min.6f6f90fcb8eb1c49ec389838e6b801d0de19430b8e516902f8d75c3c8bd98739.js integrity="sha256-b2+Q/LjrHEnsOJg45rgB0N4ZQwuOUWkC+NdcPIvZhzk="></script><link rel=apple-touch-icon sizes=128x128 href=128x128.jpg><script>var _hmt=_hmt||[];(function(){var e,t=document.createElement("script");t.src="https://hm.baidu.com/hm.js?65e05e8c0631a0d2802629f8ceb31fee",e=document.getElementsByTagName("script")[0],e.parentNode.insertBefore(t,e),console.log("欢迎加入，https://airdb.dev"),console.log("Welcome，https://airdb.dev")})()</script><nav class="app-nav pc no-badge"><div class=logo><a href=//airdb.dev/ target=__blank class=dcloud-logo></a><a href=./ class="uniapp-logo active"></a></div><div class="search nav-search"><div class=input-wrap><input type=search id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class=clear-button><svg width="26" height="24"><circle cx="12" cy="12" r="11" fill="#ccc"/><path stroke="#fff" stroke-width="2" d="M8.25 8.25l7.5 7.5"/><path stroke="#fff" stroke-width="2" d="M8.25 15.75l7.5-7.5"/></svg></div></div><div class=results-panel></div></div><ul class=nav-url></ul><ul class=nav-href><li class=ext-link><a href=https://github.com/airdb-wiki/hugo-book/discussions target=__blank>讨论区</a></li><li><a href=//github.com/sponsors/airdb target=__blank style=color:#f60!important><img src=https://bjetxgzv.cdn.bspapp.com/VKCEYUGU-uni-app-doc/45e691f0-4f3d-11eb-b680-7980c8a877b8.png class=heart>赞助我们</a></li></ul><div class=github><a href=//github.com/airdb-wiki/hugo-book target=_blank><img src=https://bjetxgzv.cdn.bspapp.com/VKCEYUGU-uni-app-doc/44f8d690-4f3d-11eb-b680-7980c8a877b8.svg></a></div></nav></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><ul><li><input type=checkbox id=section-e89db1445f21a1db2f8a9248efa53681 class=toggle checked>
<label for=section-e89db1445f21a1db2f8a9248efa53681 class="flex justify-between"><a>Golang</a></label><ul><li><a href=https://yino.github.io/wiki/go/go-laravel/>Go Laravel</a></li><li><a href=https://yino.github.io/wiki/go/Go%E5%B9%B6%E5%8F%91%E5%8E%9F%E7%90%86%E5%8F%8AGPM%E8%B0%83%E5%BA%A6%E7%AD%96%E7%95%A5/>Go并发原理及 Gpm调度策略</a></li><li><a href=https://yino.github.io/wiki/go/one_way/>One Way</a></li><li><a href=https://yino.github.io/wiki/go/%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6/>垃圾回收</a></li><li><a href=https://yino.github.io/wiki/go/%E5%B8%B8%E7%94%A8%E5%87%BD%E6%95%B0%E5%BA%93/>常用函数库</a></li><li><a href=https://yino.github.io/wiki/go/%E7%99%BE%E4%B8%87%E8%81%8A%E5%A4%A9%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/ class=active>百万聊天系统架构</a></li></ul></li><li><input type=checkbox id=section-e4b47cb361013943d92c3d1b3a85155b class=toggle>
<label for=section-e4b47cb361013943d92c3d1b3a85155b class="flex justify-between"><a>PHP</a></label><ul><li><a href=https://yino.github.io/wiki/PHP/fpm%E4%BC%98%E5%8C%96/>Fpm优化</a></li><li><a href=https://yino.github.io/wiki/PHP/function/excel-export/>Excel Export</a></li><li><a href=https://yino.github.io/wiki/PHP/function/%E5%AF%B9%E8%B1%A1%E4%B8%8E%E6%95%B0%E7%BB%84%E7%9B%B8%E4%BA%92%E8%BD%AC%E6%8D%A2/>对象与数组相互转换</a></li><li><a href=https://yino.github.io/wiki/PHP/function/%E5%B8%B8%E7%94%A8header/>常用header</a></li></ul></li><li><input type=checkbox id=section-56d67aeb85c3ecad70d4d358142db3b3 class=toggle>
<label for=section-56d67aeb85c3ecad70d4d358142db3b3 class="flex justify-between"><a>Python</a></label><ul><li><a href=https://yino.github.io/wiki/Python/common-function/>Common Function</a></li><li><a href=https://yino.github.io/wiki/Python/queue/>Queue</a></li><li><a href=https://yino.github.io/wiki/Python/selenium/>Selenium</a></li><li><a href=https://yino.github.io/wiki/Python/tf-idf/>Tf IDF</a></li><li><a href=https://yino.github.io/wiki/Python/threading/>Threading</a></li><li><a href=https://yino.github.io/wiki/Python/uswgi%E4%B8%8Enginx/>Uswgi与nginx</a></li><li><a href=https://yino.github.io/wiki/Python/%E6%95%B0%E6%8D%AE%E9%9B%86/>数据集</a></li></ul></li><li><input type=checkbox id=section-290e3c753807472c4a11761414c856fd class=toggle>
<label for=section-290e3c753807472c4a11761414c856fd class="flex justify-between"><a>VUE</a></label><ul><li><a href=https://yino.github.io/wiki/VUE/iView%E6%A1%88%E4%BE%8B/>I View案例</a></li></ul></li><li><input type=checkbox id=section-d3e74333b2ccb96d676242a4ef988186 class=toggle>
<label for=section-d3e74333b2ccb96d676242a4ef988186 class="flex justify-between"><a>MySql</a></label><ul><li><a href=https://yino.github.io/wiki/MySql/mysql%E5%BC%82%E6%AD%A5%E5%A4%8D%E5%88%B6/>Mysql异步复制</a></li><li><a href=https://yino.github.io/wiki/MySql/%E4%BA%8B%E5%8A%A1%E9%9A%94%E7%A6%BB%E7%BA%A7%E5%88%AB/>事务隔离级别</a></li><li><a href=https://yino.github.io/wiki/MySql/%E5%88%9B%E5%BB%BA%E5%87%BD%E6%95%B0/>创建函数</a></li><li><a href=https://yino.github.io/wiki/MySql/%E5%88%9B%E5%BB%BA%E7%94%A8%E6%88%B7%E5%B9%B6%E6%8E%88%E6%9D%83/>创建用户并授权</a></li><li><a href=https://yino.github.io/wiki/MySql/%E5%B8%B8%E8%A7%81%E5%87%BD%E6%95%B0/>常见函数</a></li><li><a href=https://yino.github.io/wiki/MySql/%E5%BF%98%E8%AE%B0%E5%AF%86%E7%A0%81/>忘记密码</a></li></ul></li><li><input type=checkbox id=section-fbf96c40060222e6abb418fd9a6bc7e5 class=toggle>
<label for=section-fbf96c40060222e6abb418fd9a6bc7e5 class="flex justify-between"><a>Redis</a></label><ul><li><a href=https://yino.github.io/wiki/Redis/%E5%BC%82%E6%AD%A5%E5%A4%8D%E5%88%B6/>异步复制</a></li></ul></li><li><input type=checkbox id=section-6da4cf37de0c2f2fde13cc4c178f792b class=toggle>
<label for=section-6da4cf37de0c2f2fde13cc4c178f792b class="flex justify-between"><a>Mango</a></label><ul></ul></li><li><input type=checkbox id=section-38d3becc35e924b35eb3daa5a1e6504d class=toggle>
<label for=section-38d3becc35e924b35eb3daa5a1e6504d class="flex justify-between"><a>Docker</a></label><ul><li><a href=https://yino.github.io/wiki/Docker/Dockerfile/>Dockerfile</a></li><li><a href=https://yino.github.io/wiki/Docker/nginx-php-mysql%E4%B8%80%E4%BB%B6%E9%83%A8%E7%BD%B2/>Nginx Php Mysql一件部署</a></li><li><a href=https://yino.github.io/wiki/Docker/%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/>常用命令</a></li></ul></li><li><input type=checkbox id=section-d9101885ad911559b7cf9f595ebaf7bd class=toggle>
<label for=section-d9101885ad911559b7cf9f595ebaf7bd class="flex justify-between"><a>Nginx</a></label><ul><li><a href=https://yino.github.io/wiki/Nginx/rewrite%E4%B8%8Eproxy_pass/>Rewrite与proxy Pass</a></li><li><a href=https://yino.github.io/wiki/Nginx/%E7%A6%81%E7%BD%91%E6%AE%B5/>禁网段</a></li></ul></li><li><input type=checkbox id=section-da074c18303a1ad12b6ba4fe6f70f667 class=toggle>
<label for=section-da074c18303a1ad12b6ba4fe6f70f667 class="flex justify-between"><a>Linux</a></label><ul><li><a href=https://yino.github.io/wiki/Linux/CentOS%E6%90%AD%E5%BB%BAShadowsocks%E6%9C%8D%E5%8A%A1%E7%AB%AF/>Cent Os搭建 Shadowsocks服务端</a></li><li><a href=https://yino.github.io/wiki/Linux/Prometheus/>Prometheus</a></li><li><a href=https://yino.github.io/wiki/Linux/%E5%88%86%E7%BB%84/>分组</a></li><li><a href=https://yino.github.io/wiki/Linux/%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/>常用命令</a></li></ul></li><li><input type=checkbox id=section-a56d65510185b81503293e88d070df19 class=toggle>
<label for=section-a56d65510185b81503293e88d070df19 class="flex justify-between"><a>微服务</a></label><ul><li><a href=https://yino.github.io/wiki/%E5%BE%AE%E6%9C%8D%E5%8A%A1/consul/>Consul</a></li></ul></li><li><input type=checkbox id=section-9a2f275de5a06924130cde8cb78c8bc3 class=toggle>
<label for=section-9a2f275de5a06924130cde8cb78c8bc3 class="flex justify-between"><a>领域驱动设计</a></label><ul><li><a href=https://yino.github.io/wiki/DDD/domain/>Domain</a></li><li><a href=https://yino.github.io/wiki/DDD/PO-DO-VO-DTO/>Po Do Vo Dto</a></li><li><a href=https://yino.github.io/wiki/DDD/%E5%AE%9E%E8%B7%B5/>实践</a></li><li><a href=https://yino.github.io/wiki/DDD/%E6%AD%A5%E9%AA%A4/>步骤</a></li><li><a href=https://yino.github.io/wiki/DDD/%E7%A4%BA%E4%BE%8B/>示例</a></li><li><a href=https://yino.github.io/wiki/DDD/%E8%81%9A%E5%90%88/>聚合</a></li></ul></li><li><input type=checkbox id=section-360d6906cb2b7438909fd98a7c415e74 class=toggle>
<label for=section-360d6906cb2b7438909fd98a7c415e74 class="flex justify-between"><a>规划</a></label><ul><li><a href=https://yino.github.io/wiki/Target/program/>Program</a></li><li><a href=https://yino.github.io/wiki/Target/target/>Target</a></li></ul></li></ul><div class=contact-item><div class=contact-smg><div>扫码添加企业微信</div><img src=https://airdb.dev/hugo-book/qrcode.png width=90 height=90></div></div></nav><script>(function(){var e=document.querySelector("aside.book-menu nav");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/svg/menu.svg class=book-icon alt=Menu>
</label><strong>百万聊天系统架构</strong>
<label for=toc-control><img src=/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><ul><li><ul><li><a href=#聊天系统架构-百万级-bs><strong>聊天系统架构 百万级 B/S</strong></a></li></ul></li></ul></li></ul></nav></aside></header><article class=markdown><h3 id=聊天系统架构-百万级-bs><strong>聊天系统架构 百万级 B/S</strong>
<a class=anchor href=#%e8%81%8a%e5%a4%a9%e7%b3%bb%e7%bb%9f%e6%9e%b6%e6%9e%84-%e7%99%be%e4%b8%87%e7%ba%a7-bs>#</a></h3><p>场景：100w人同时在线</p><h4 id=技术选型>技术选型
<a class=anchor href=#%e6%8a%80%e6%9c%af%e9%80%89%e5%9e%8b>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>B/S架构下 通常有两种方案：
</span></span><span style=display:flex><span>1. 客户端主动向服务器拉取数据
</span></span><span style=display:flex><span>2. 服务器主动向客户端发送数据
</span></span><span style=display:flex><span>以上两种情况在B/S架构下通常对应着：http轮询 和 websocket
</span></span><span style=display:flex><span>在线用户达到一定量级情况下，客户端主动拉取数据就会达到一定的瓶颈：对单表、api压力过大；
</span></span><span style=display:flex><span>因此在用户量级略高的情况下建议采用 websocket
</span></span></code></pre></div><h4 id=websocket单机架构>websocket单机架构
<a class=anchor href=#websocket%e5%8d%95%e6%9c%ba%e6%9e%b6%e6%9e%84>#</a></h4><p>websocket 单机架构 代码案例地址:
<a href=https://gitee.com/sun17ya/go-websocket>gitee</a>
<a href=https://github.com/yino/go-websocket>github</a></p><h5 id=技术难点>技术难点
<a class=anchor href=#%e6%8a%80%e6%9c%af%e9%9a%be%e7%82%b9>#</a></h5><ol><li>内核瓶颈</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>推送量大：100W*10条/秒=1000W条/秒
</span></span><span style=display:flex><span>内核瓶颈：linux内核发送TCP极限包频≈100w
</span></span></code></pre></div><ol start=2><li>锁瓶颈</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>需要维护一个100w人的流量在线集合，通常是一个字典结构
</span></span><span style=display:flex><span>推送消息即遍历整个集合，顺序发送消息，耗时极长
</span></span><span style=display:flex><span>推送期间，客户端一直在进行上下线，所以需要对 map上锁
</span></span></code></pre></div><ol start=3><li>cpu瓶颈</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>浏览器与服务器之间通常采用json格式通讯
</span></span><span style=display:flex><span>json编码非常消耗cpu
</span></span><span style=display:flex><span>每秒100w次json encode
</span></span></code></pre></div><h5 id=解决方案>解决方案
<a class=anchor href=#%e8%a7%a3%e5%86%b3%e6%96%b9%e6%a1%88>#</a></h5><ol><li>内核瓶颈</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>减少网络小包的发送 
</span></span><span style=display:flex><span>将同一秒内推送的弹幕合并成一条，合并后每秒推送次数只等于在线连接数
</span></span></code></pre></div><ol start=2><li>锁瓶颈</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>大锁拆为多个小锁 创建原子变量，每个连接可以+1分配到一个唯一id，利用ID做hash取模到某个set中推送消息即遍历整个集合，顺序发送消息，耗时极长
</span></span><span style=display:flex><span>连接打散到多个集合中，每个集合有自己的锁
</span></span><span style=display:flex><span>多线程并发推送多个集合，避免锁的竞争
</span></span><span style=display:flex><span>读写锁取代互斥锁，多个推送任务可以并发便利相同集合
</span></span></code></pre></div><ol start=3><li>cpu瓶颈</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>
</span></span><span style=display:flex><span>浏览器与服务器之间通常采用json格式通讯，json编码非常消耗cpu，每秒100w次json encode；因此减少计算次数
</span></span></code></pre></div><p>单机瓶颈 还有以下</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>维护海量长链接会花费不少内存
</span></span><span style=display:flex><span>消息推送瞬时消耗大量CPU资源
</span></span><span style=display:flex><span>消息推送瞬时带宽高达400～600M（4-6Gbits）,是主要瓶颈
</span></span></code></pre></div><p><img src=/img/websocket_one.jpg alt></p><h4 id=websocket分布式架构>websocket分布式架构
<a class=anchor href=#websocket%e5%88%86%e5%b8%83%e5%bc%8f%e6%9e%b6%e6%9e%84>#</a></h4><h5 id=网关集群>网关集群
<a class=anchor href=#%e7%bd%91%e5%85%b3%e9%9b%86%e7%be%a4>#</a></h5><p><img src=/img/websocket_gateway.jpg alt></p><p>通过负载均衡将连接打散在不同的网关服务器上，网关服务器可横向扩展；</p><p>但是会引出一个新的问题：当服务器推送消息时如何知道指定的用户在哪个服务器上：
最简单的解决方案是：将消息广播到所有的网关服务器上，网关服务器自主去决策是否在当前服务器，并进行发送；因此需要一个<strong>逻辑集群</strong></p><h5 id=逻辑集群>逻辑集群
<a class=anchor href=#%e9%80%bb%e8%be%91%e9%9b%86%e7%be%a4>#</a></h5><p>基于HTTP/2 协议向gateway 集群分发消息；HTTP/2 支持连接复用，用作RPC性能更佳；</p><p>基于HTTP/1 协议对外提供推送API；HTTP/1 更加普及，对业务更加友好；
<img src=/img/websocket_distributed_complate.jpg alt></p><p>当然我们也可以将逻辑集群中的HTTP 更换为消息中间件，采用消息订阅的方式分发给gateway；</p></article><footer class=book-footer><div class="flex flex-wrap justify-between"><div><a class="flex align-center" href=https://github.com/yino/yino.github.io/edit/main/exampleSite/content/wiki/go/%e7%99%be%e4%b8%87%e8%81%8a%e5%a4%a9%e7%b3%bb%e7%bb%9f%e6%9e%b6%e6%9e%84.md target=_blank rel=noopener><img src=/svg/edit.svg class=book-icon alt=Edit>
<span>Edit this page</span></a></div></div></footer><div class=book-comments></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><ul><li><ul><li><a href=#聊天系统架构-百万级-bs><strong>聊天系统架构 百万级 B/S</strong></a></li></ul></li></ul></li></ul></nav></div></aside></main></body></html>